CREATE DEFINER=`admin`@`%` PROCEDURE `FETCH_NOTIFICATION_EMAIL_DETAILS`(
IN in_entity_type varchar(10),
IN in_entity_id varchar(36),
IN in_entity_name varchar(100),
IN in_entity_status varchar(50),
IN in_action varchar(20),
IN in_action_performed_by varchar(36),
IN in_time_of_action Timestamp,
IN in_message_id varchar(200),
IN in_active_profile varchar(10))
BEGIN
  DECLARE v_email_sender varchar(50) DEFAULT "";
  DECLARE v_email_addressee varchar(50) DEFAULT "";
  DECLARE v_email_recepient varchar(50) DEFAULT "";
  DECLARE v_email_recepient_id varchar(36) DEFAULT "";
  DECLARE v_organisation_id varchar(36) DEFAULT "";
  DECLARE v_organisation_name varchar(255) DEFAULT "";
  DECLARE v_fund_manager varchar(255) DEFAULT "";
  DECLARE v_result varchar(2000) DEFAULT "";
  DECLARE v_result1 varchar(2000) DEFAULT "";
  DECLARE v_result_addressee varchar(50) DEFAULT "";
  DECLARE v_email_to varchar(2000) DEFAULT "";
  DECLARE v_email_cc varchar(2000) DEFAULT "";
  DECLARE v_email_bcc varchar(2000) DEFAULT "";
  DECLARE v_email_subject varchar(150) DEFAULT "";
  DECLARE v_email_body text DEFAULT "";
  DECLARE v_email_body1 varchar(500) DEFAULT "";
  DECLARE v_email_body2 varchar(500) DEFAULT "";
  DECLARE v_email_body3 varchar(500) DEFAULT "";
  DECLARE v_user_comments varchar(200) DEFAULT "";
  DECLARE v_email_signature text DEFAULT "";
  DECLARE v_Qualis_portal varchar(150) DEFAULT "";
  DECLARE v_fund_name varchar(100) DEFAULT "";
  DECLARE v_investor_name varchar(100) DEFAULT "";
  DECLARE v_amount varchar(100) DEFAULT "";
  DECLARE v_last_updated_at varchar(100) DEFAULT "";
  DECLARE v_bank_detail varchar(255) DEFAULT "";
  DECLARE v_event_name varchar(50) DEFAULT "";
  DECLARE v_qualis_users varchar(200) DEFAULT "";
  DECLARE v_action_perform_by_fname varchar(50) DEFAULT "";
  DECLARE v_action_perform_by_lname varchar(50) DEFAULT "";
  DECLARE v_present_status varchar(50) DEFAULT "";
  DECLARE done INT DEFAULT 0;
  DECLARE v_behalf_of_user varchar(50) DEFAULT "";
  DECLARE v_amount_requested varchar(100) DEFAULT "";
  DECLARE v_order_created_date Timestamp DEFAULT Current_Timestamp;

DECLARE cur_email_recepient_Funds_Add CURSOR FOR select distinct u.user_id,u.user_name,u.first_name
from qaip_user u where u.active=true AND u.user_id in (select distinct utr.user_id from qaip_user_team_role utr
where utr.role_id in (select distinct r.role_id from qaip_role r where r.category_id =1
and r.privilege_id in (select distinct p.privilege_id from qaip_privilege p
where privilege like '%{"approvalaccess":true,"menu":"User Management","viewaccess":true,"createaccess":true,"modifyaccess":true}%')));

DECLARE cur_email_recepient_Funds_Upd CURSOR FOR select distinct u.user_id,u.user_name,u.first_name
from qaip_user u where u.user_id in(
select distinct w.user_id from qaip_funds_watchlist w where w.fund_id =in_entity_id)
UNION
select distinct u.user_id,u.user_name,u.first_name
from qaip_user u where u.user_id in(select distinct o.created_by
from qaip_order_mgmt o where o.fund_id =in_entity_id and o.order_status_id<>'10');

DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

select distinct url INTO v_Qualis_portal from qaip_master_portal_urls where active_profile=in_active_profile;

SET v_email_signature=CONCAT('<p>Regards,</p><p style="font-family:sans-serif"> <span style="color:#997300;font-weight: bold;">Team Qualis</span><p> 1 Rockefeller Plaza | Suite 1640 <br> New York, NY 10020 <br> <a href="www.qualiscapital.com">www.qualiscapital.com</a><br> <p> Contact Us:<a href="info@qualiscapital.com">info@qualiscapital.com</a></p><br><br></p><img border="0" alt="qualiscapital.png" style="padding:0px 20px 20px 0px" width="100" height="120" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZEAAABQCAYAAADY4kjyAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAzUSURBVHgB7Z29lk1LF4bX+cYJuQAugBw5F4AcyUmQI0eOHMGRNDkugBw5F8AFkPd3nj3MHrPL+q219u7dvZ9njD26e/f6qVU/862aNavWX/v7+/80TfNvIyIiMo1X/2tEREQqUURERKQaRURERKpRREREpBpFREREqlFERESkGkVERESqUURERKQaRURERKpRREREpBpFREREqlFERESkGkVERESqUURERKQaRURERKpRREREpBpFREREqlFERESkGkVERESqUURERKSav/v++f379+b9+/fNJjh9+nRz48aN0ceTLtIH586da65cudJMJV9jKaY+B7x48eLgd56D55lKvsbFixdXn6X5+fNn8+bNm4O/r1692pw9e7YRkd2lV0R+/PhxyDitE4zRFOP77t275vPnz6vfr127ViUi+RpLMfU5IOcx588VEYRsb29vcQOPiJRipYiI7Da6s04gGPvHjx83IiLrpnckcubMmVUvfyy4hnLPfsq5p06dao4SnvXSpUvNXI76OQLKAdfT1FGRiMgUekUEV8XDhw+bsTDHkEVkyrlHDQJynNI7BlxPuJxq3GMiImPQnXWCwa316NGj1U8RkXWgiJxA8sjj27dvGwuOEJHdQxE5gdy8efPQfBRzI0tHoYmIgCJyQrl3794qWCDQrSUi60AROaGwVgThCFjzY9iviCyNInKCITIrh/h++PDh0IpzEZG5KCInnPv37x+aaGeSfemtXkRkd1FEdoAnT56s3FvganYRWRJFZAdg0eidO3cO/iZS6+nTp42IyFwUkR2BuZG8s69hv/0wYit3YBCRP/m7kZ0Bt9b169cPQn2J3nr9+vWBq2ubYJEkgQBDMN/DZ8ndhJkzunv37iqiDZhXcg+yaZSvWah9PUHb6ygoi22os/kZ1/X6heOAIrJD0PAQEgwkxFb/GMltY+pKexowe58tISZfvnw5EBBgNKKITKN8zQLl8/z582YqlEVZD3iPzTaISH5G3MWKyI5D73yu64Ie8Tb26jMR9huhvvzku5r3sWwTlB2jrCVGDeWGldtuHChDRpSwrRuJUj58puZljfDsKnmX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"/>');


IF(in_entity_type='Fund' AND in_action='Add') THEN

select distinct email_sender INTO v_email_sender from qaip_master_email_metadata where entity_type=in_entity_type and action_performed=in_action;
select distinct email_subject INTO v_email_subject from qaip_master_email_metadata where entity_type=in_entity_type and action_performed=in_action;
  OPEN cur_email_recepient_Funds_Add;
  forLoopAdd: LOOP
  FETCH cur_email_recepient_Funds_Add INTO v_email_recepient_id,v_email_bcc,v_email_addressee;

  IF done = 1 THEN
        LEAVE forLoopAdd;
    END IF;

SET v_Qualis_portal=CONCAT(v_Qualis_portal,'#/funds/', in_entity_id);

SET v_email_body1=CONCAT('<html>','<body style="font-weight: normal;font-family: sans-serif;font-size: small;">','<p>Dear <a>',v_email_addressee,',</a><br><br>');
SET v_email_body2=CONCAT('Qualis Capital is pleased to announce that ',in_entity_name, ' has been added to the Qualis Platform. ','</p><p>Please log into the Qualis Portal <a href=',v_Qualis_portal,'> here </a> or reach out to your Quails representative for more information.</p>');
SET v_email_body=CONCAT(v_email_body1,v_email_body2,v_email_signature);


  insert into qaip_notification_email_delivery_receipt
(email_identifier,entity_type,entity_id,email_trigger,email_triggered_status,email_triggered_by,email_triggered_date,email_sender,
email_addressee,email_subject,email_body,email_bcc,email_delivery_status)
values(in_message_id,in_entity_type,in_entity_id,in_action,in_entity_status,in_action_performed_by,
in_time_of_action,v_email_sender,v_email_addressee,v_email_subject,v_email_body,v_email_bcc,
'PENDING');

commit;

insert into qaip_notification_email_profile_funds(email_identifier,fund_id,fund_name,status,action)
values(in_message_id,in_entity_id,in_entity_name,in_entity_status,in_action);

commit;

call INSERT_NOTIFICATION_EMAIL_RECEPIENT_LOG(in_message_id,v_email_recepient_id,v_email_bcc);

commit;



END LOOP forLoopAdd;

CLOSE cur_email_recepient_Funds_Add;

select * from qaip_notification_email_delivery_receipt where email_identifier=in_message_id;

ELSEIF(in_entity_type='Fund' AND in_action='Performance') THEN

select distinct u.user_id,u.user_name,u.organisation_id INTO v_email_recepient_id,v_email_bcc,v_organisation_id from qaip_user u where u.user_id = (select distinct o.created_by from qaip_order_mgmt o where o.order_id = in_entity_id);

select distinct email_sender INTO v_email_sender from qaip_master_email_metadata where entity_type=in_entity_type and action_performed=in_action;
select distinct email_subject INTO v_email_subject from qaip_master_email_metadata where entity_type=in_entity_type and action_performed=in_action;
SET v_Qualis_portal=CONCAT(v_Qualis_portal,'#/funds');
CALL INSERT_NOTIFICATION_EMAIL_QUALIS_USERS_LOG(in_message_id,v_organisation_id,@v_result);

SET v_email_to=@v_result;

SET v_email_addressee='Qualis Team';

SET v_email_body1=CONCAT('<html>','<body style="font-weight: normal;font-family: sans-serif;font-size: small;">','<p>Dear <a>',v_email_addressee,',</a><br><br>');
SET v_email_body2=CONCAT('The latest monthly platform performance update has been uploaded to the Qualis portal. This monthly update provides the performance and relevant metrics for all the funds on the Qualis Platform. Performance Summary can be found <a href=',v_Qualis_portal,'>here</a>.<br>');
SET v_email_body=CONCAT(v_email_body1,v_email_body2,v_email_signature);

insert into qaip_notification_email_delivery_receipt
(email_identifier,entity_type,entity_id,email_trigger,email_triggered_status,email_triggered_by,email_triggered_date,email_sender,
email_addressee,email_subject,email_body,email_to,email_cc,email_delivery_status)
values(in_message_id,in_entity_type,in_entity_id,in_action,in_entity_status,in_action_performed_by,
in_time_of_action,v_email_sender,v_email_addressee,v_email_subject,v_email_body,v_email_to,
null,'PENDING');

commit;

insert into qaip_notification_email_profile_funds(email_identifier,fund_id,fund_name,status,action)
values(in_message_id,in_entity_id,in_entity_name,in_entity_status,in_action);

commit;

select * from qaip_notification_email_delivery_receipt where email_identifier=in_message_id;

ELSEIF (in_entity_type='Fund' AND in_action='Update') THEN

OPEN cur_email_recepient_Funds_Upd;

select distinct email_sender INTO v_email_sender from qaip_master_email_metadata where entity_type=in_entity_type and action_performed=in_action;
select distinct email_subject INTO v_email_subject from qaip_master_email_metadata where entity_type=in_entity_type and action_performed=in_action;
  forLoopUpdate: LOOP
  FETCH cur_email_recepient_Funds_Upd INTO v_email_recepient_id,v_email_bcc,v_email_addressee;

  IF done = 1 THEN
        LEAVE forLoopUpdate;
    END IF;

SET v_Qualis_portal=CONCAT(v_Qualis_portal,'#/funds/', in_entity_id);

SET v_email_body1=CONCAT('<html>','<body style="font-weight: normal;font-family: sans-serif;font-size: small;">','<p>Dear <a>',v_email_addressee,',</a><br><br>');
SET v_email_body2=CONCAT(in_entity_name,' has had some important details changed. Please log into <a href=',v_Qualis_portal,'>https://app.tifinprivatemarkets.com</a> to learn more. ','</p>');
SET v_email_body=CONCAT(v_email_body1,v_email_body2,v_email_signature);


insert into qaip_notification_email_delivery_receipt
(email_identifier,entity_type,entity_id,email_trigger,email_triggered_status,email_triggered_by,email_triggered_date,email_sender,
email_addressee,email_subject,email_body,email_bcc,email_delivery_status)
values(in_message_id,in_entity_type,in_entity_id,in_action,in_entity_status,in_action_performed_by,
in_time_of_action,v_email_sender,v_email_addressee,v_email_subject,v_email_body,v_email_bcc,
'PENDING');
commit;

insert into qaip_notification_email_profile_funds(email_identifier,fund_id,fund_name,status,action)
values(in_message_id,in_entity_id,in_entity_name,in_entity_status,in_action);

commit;

call INSERT_NOTIFICATION_EMAIL_RECEPIENT_LOG(in_message_id,v_email_recepient_id,v_email_bcc);


END LOOP forLoopUpdate;

CLOSE cur_email_recepient_Funds_Upd;

select * from qaip_notification_email_delivery_receipt where email_identifier=in_message_id;

elseif(in_entity_type='Order' AND (in_action='Update' OR in_action='Add' OR in_action='Document')) THEN

select distinct email_sender INTO v_email_sender from qaip_master_email_metadata where entity_type=in_entity_type and action_performed=in_action and entity_status=in_entity_status;
select distinct email_subject INTO v_email_subject from qaip_master_email_metadata where entity_type=in_entity_type and action_performed=in_action and entity_status=in_entity_status;

update qaip_funds set bank_details = REPLACE(bank_details, '\n', '<br>') where fund_id = (select distinct fund_id from qaip_order_mgmt
where order_id=in_entity_id);

commit;

select distinct fund_name,bank_details INTO v_fund_name,v_bank_detail from qaip_funds where fund_id = (select distinct fund_id from qaip_order_mgmt
where order_id=in_entity_id);

update qaip_funds set bank_details = REPLACE(bank_details, '<br>', '\n') where fund_id = (select distinct fund_id from qaip_order_mgmt
where order_id=in_entity_id);

commit;

select distinct account_name INTO v_investor_name from qaip_investors where investor_id = (select distinct investor_id from qaip_order_mgmt
where order_id=in_entity_id);

select (select user_id from qaip_user where user_id = a.behalf_of) as behalf_of INTO v_behalf_of_user from qaip_notification_activity_log a where entity_id = in_entity_id order by time_of_action asc LIMIT 1;

IF(v_behalf_of_user IS null) THEN
select organisation_name INTO v_organisation_name from qaip_organisation where organisation_id=(select organisation_id from qaip_user
where user_id=(select created_by from qaip_order_mgmt where order_id=in_entity_id));
ELSE
select organisation_name INTO v_organisation_name from qaip_organisation where organisation_id=(select organisation_id from qaip_user
where user_id=v_behalf_of_user);
END IF;

select organisation_name INTO v_fund_manager from qaip_organisation where organisation_id=(select fund_manager_id from qaip_funds where
fund_id=(select fund_id from qaip_order_mgmt
where order_id=in_entity_id));

select distinct order_event_name,o.event_amount,o.last_updated_date,o.amount_requested,o.created_date INTO v_event_name,v_amount,v_last_updated_at,v_amount_requested,v_order_created_date from qaip_order_mgmt o,qaip_order_event e
where o.order_id =in_entity_id
and o.order_event_id =e.order_event_id;

select DATE_FORMAT(v_last_updated_at, "%d %b %Y") INTO v_last_updated_at;

IF(v_amount IS null) THEN
SET v_amount='NA';
ELSE
SET v_amount=CONCAT('USD ',FORMAT(v_amount,2));
END IF;


IF in_entity_status='SENT TO QUALIS' THEN

    select distinct u.user_id,u.user_name,u.organisation_id INTO v_email_recepient_id,v_email_bcc,v_organisation_id from qaip_user u where u.user_id = (select distinct o.created_by from qaip_order_mgmt o
	where o.order_id = in_entity_id);

	CALL INSERT_NOTIFICATION_EMAIL_QUALIS_USERS_LOG(in_message_id,v_organisation_id,@v_result);

	SET v_email_to=@v_result;

	CALL INSERT_NOTIFICATION_EMAIL_RECEPIENT_LOG(in_message_id,v_email_recepient_id,v_email_bcc);

	SET v_email_addressee='Qualis Team';
    SET v_Qualis_portal=CONCAT(v_Qualis_portal,'#/orders/',in_entity_id);

SET v_email_body1=CONCAT('<html>','<body style="font-weight: normal;font-family: sans-serif;font-size: small;">','<p>Dear <a>',v_email_addressee,',</a><br><br>');
If(in_action='Document') THEN
SET v_email_body2=CONCAT('The order of ',v_fund_name,' for ',v_amount,' has been updated with one or more documents. Order details can be found <a href=',v_Qualis_portal,'>here</a></p><ul><li>Order No: ',in_entity_id,'</li><li>Status: ',in_entity_status,'</li><li>Status Changed at: ',v_last_updated_at,'</li><li>Dealer Group: ',v_organisation_name,'</li><li>Fund Manager: ',v_fund_manager,'</li></ul><br>');
ELSEIF(in_action='Update') THEN
SET v_email_body2=CONCAT('A new order has been submitted for your review. <a href=',v_Qualis_portal,'>here</a></p><ul><li>Order No: ',in_entity_id,'</li><li>Status: ',in_entity_status,'</li><li>Status Changed at: ',v_last_updated_at,'</li><li>Dealer Group: ',v_organisation_name,'</li><li>Fund Manager: ',v_fund_manager,'</li></ul><br>');
END IF;
SET v_email_body=CONCAT(v_email_body1,v_email_body2,v_email_signature);

ELSEIF in_entity_status='SENT TO APPROVER' AND in_action='Document' THEN

	CALL INSERT_NOTIFICATION_EMAIL_DG_USERS_LOG(in_message_id,in_entity_id,@v_result);

	SET v_email_to=@v_result;

	select distinct u.user_id,u.user_name,u.organisation_id INTO v_email_recepient_id,v_email_bcc,v_organisation_id from qaip_user u where u.user_id = (select distinct o.created_by from qaip_order_mgmt o
	where o.order_id = in_entity_id);

	CALL INSERT_NOTIFICATION_EMAIL_RECEPIENT_LOG(in_message_id,v_email_recepient_id,v_email_bcc);

	SET v_email_addressee='All';
    SET v_Qualis_portal=CONCAT(v_Qualis_portal,'#/orders/',in_entity_id);

SET v_email_body1=CONCAT('<html>','<body style="font-weight: normal;font-family: sans-serif;font-size: small;">','<p>Dear <a>',v_email_addressee,',</a><br><br>');
SET v_email_body2=CONCAT('The order of ',v_fund_name,' for ',v_amount,' has been updated with one or more documents. Order details can be found <a href=',v_Qualis_portal,'>here</a></p><ul><li>Order No: ',in_entity_id,'</li><li>Status: ',in_entity_status,'</li><li>Status Changed at: ',v_last_updated_at,'</li><li>Dealer Group: ',v_organisation_name,'</li><li>Fund Manager: ',v_fund_manager,'</li></ul><br>');
SET v_email_body=CONCAT(v_email_body1,v_email_body2,v_email_signature);


elseif(in_entity_status='SENT TO FUND MANAGER' ) THEN

select distinct u.user_id,u.user_name,u.organisation_id INTO v_email_recepient_id,v_email_bcc,v_organisation_id from qaip_user u where u.user_id = (select distinct o.created_by from qaip_order_mgmt o
	where o.order_id = in_entity_id);

CALL INSERT_NOTIFICATION_EMAIL_QUALIS_USERS_LOG(in_message_id,v_organisation_id,@v_result1);

	SET v_email_bcc=@v_result1;

	CALL INSERT_NOTIFICATION_ORDER_EMAIL_FM_LOG(in_entity_id,in_message_id,@v_result_addressee,@v_result);

	SET v_email_to=@v_result;

	SET v_email_addressee=@v_result_addressee;

	SET v_Qualis_portal=CONCAT(v_Qualis_portal,'#/orders/',in_entity_id);

SET v_email_body1=CONCAT('<html>','<body style="font-weight: normal;font-family: sans-serif;font-size: small;">','<p>Dear <a>',v_email_addressee,',</a><br><br>');
If(in_action='Document') THEN
SET v_email_body2=CONCAT('The order of ',v_fund_name,' for ',v_amount,' has been updated with one or more documents. Order details can be found <a href=',v_Qualis_portal,'>here</a></p><ul><li>Order No: ',in_entity_id,'</li><li>Status: ',in_entity_status,'</li><li>Status Changed at: ',v_last_updated_at,'</li><li>Dealer Group: ',v_organisation_name,'</li><li>Fund Manager: ',v_fund_manager,'</li></ul><br>');
ELSEIF(in_action='Update') THEN
SET v_email_body2=CONCAT('Please refer to the new orders created today <a href=',v_Qualis_portal,'>here</a> ','</p>','<br><p>Under the Orders tab, you will find the new ',v_event_name,', please review and use the drop down menu to accept or request more information. </p><ul><li>Order No: ',in_entity_id,'</li><li>Status: ',in_entity_status,'</li><li>Status Changed at: ',v_last_updated_at,'</li><li>Dealer Group: ',v_organisation_name,'</li><li>Fund Manager: ',v_fund_manager,'</li></ul><br>');
END IF;
SET v_email_body=CONCAT(v_email_body1,v_email_body2,v_email_signature);



elseif(in_entity_status='ORDER ACCEPTED' OR in_entity_status='ORDER REJECTED') THEN


SET v_Qualis_portal=CONCAT(v_Qualis_portal,'#/orders/',in_entity_id);

select distinct u.user_id,u.user_name,u.first_name,u.organisation_id INTO v_email_recepient_id,v_email_to,v_email_addressee,v_organisation_id from qaip_user u where u.user_id = (select distinct o.created_by from qaip_order_mgmt o
	where o.order_id = in_entity_id);

	CALL INSERT_NOTIFICATION_EMAIL_QUALIS_USERS_LOG(in_message_id,v_organisation_id,@v_result);

	SET v_email_bcc=@v_result;

	CALL INSERT_NOTIFICATION_EMAIL_RECEPIENT_LOG(in_message_id,v_email_recepient_id,v_email_to);


SET v_email_body1=CONCAT('<html>','<body style="font-weight: normal;font-family: sans-serif;font-size: small;">','<p>Dear <a>',v_email_addressee,',</a><br><br>');
If(in_action='Document') THEN
SET v_email_body2=CONCAT('The order of ',v_fund_name,' for ',v_amount,' has been updated with one or more documents. Order details can be found <a href=',v_Qualis_portal,'>here</a></p><ul><li>Order No: ',in_entity_id,'</li><li>Status: ',in_entity_status,'</li><li>Status Changed at: ',v_last_updated_at,'</li><li>Dealer Group: ',v_organisation_name,'</li><li>Fund Manager: ',v_fund_manager,'</li></ul><br>');
ELSEIF(in_action='Update') THEN
If(in_entity_status='ORDER ACCEPTED') THEN
SET v_email_body2=CONCAT('The ',v_event_name,' of ',v_fund_name,' for ',v_amount,' has been accepted. Order details can be found <a href=',v_Qualis_portal,'>here</a>.');
ELSEIF(in_entity_status='ORDER REJECTED') THEN

select distinct c.comment INTO v_user_comments from qaip_user_comments c where c.user_id=in_action_performed_by
and c.order_id=in_entity_id
and c.last_updated_date=(select max(c1.last_updated_date)
from qaip_user_comments c1
where c1.user_id=in_action_performed_by
and c1.order_id=in_entity_id);

SET v_email_body2=CONCAT('The ',v_event_name,' of ',v_fund_name,' for ',v_amount,' has been rejected because ');
SET v_email_body3=CONCAT(v_user_comments,'</p>');

END IF;
END IF;

If(v_event_name='Subscription' AND in_entity_status='ORDER ACCEPTED' AND in_action='Update') THEN
  SET v_email_body3=CONCAT('<br>','<br> If subscription, please wire the funds to: <br><p style="white-space: pre-wrap;">',v_bank_detail,'</p><br></p></p><ul><li>Order No: ',in_entity_id,'</li><li>Status: ',in_entity_status,'</li><li>Status Changed at: ',v_last_updated_at,'</li><li>Dealer Group: ',v_organisation_name,'</li><li>Fund Manager: ',v_fund_manager,'</li></ul><br>');
elseif(v_event_name='Redemption' AND in_entity_status='ORDER ACCEPTED' AND in_action='Update') THEN
   SET v_email_body3=CONCAT('<br><br>','Amount will be wired to the clients account.','</p></p><ul><li>Order No: ',in_entity_id,'</li><li>Status: ',in_entity_status,'</li><li>Status Changed at: ',v_last_updated_at,'</li><li>Dealer Group: ',v_organisation_name,'</li><li>Fund Manager: ',v_fund_manager,'</li></ul><br>');
end if;
SET v_email_body=CONCAT(v_email_body1,v_email_body2,v_email_body3,v_email_signature);

elseif(in_entity_status='ORDER CANCELLED') THEN

SELECT entity_status into v_present_status from qaip_notification_activity_log where entity_id=in_entity_id and entity_status <> 'ORDER CANCELLED' order by audit_id desc limit 1;
SET v_Qualis_portal=CONCAT(v_Qualis_portal,'#/orders/',in_entity_id);

If(v_present_status = 'SENT TO QUALIS') THEN
    select distinct u.user_id,u.user_name,u.first_name,u.organisation_id INTO v_email_recepient_id,v_email_to,v_email_addressee,v_organisation_id from qaip_user u where u.user_id = (select distinct o.created_by from qaip_order_mgmt o
	where o.order_id = in_entity_id);

	CALL INSERT_NOTIFICATION_EMAIL_QUALIS_USERS_LOG(in_message_id,v_organisation_id,@v_result);

	SET v_email_bcc=@v_result;

	CALL INSERT_NOTIFICATION_EMAIL_RECEPIENT_LOG(in_message_id,v_email_recepient_id,v_email_to);


SET v_email_body1=CONCAT('<html>','<body style="font-weight: normal;font-family: sans-serif;font-size: small;">','<p>Dear <a>',v_email_addressee,',</a><br><br>');
SET v_email_body2=CONCAT('The ',v_event_name,' of ',v_fund_name,' for ',v_amount,' has been cancelled. Order details can be found <a href=',v_Qualis_portal,'>here</a>.');

SET v_email_body3=CONCAT('<br><br>','</p></p><ul><li>Order No: ',in_entity_id,'</li><li>Status: ',in_entity_status,'</li><li>Status Changed at: ',v_last_updated_at,'</li><li>Dealer Group: ',v_organisation_name,'</li><li>Fund Manager: ',v_fund_manager,'</li></ul><br>');

SET v_email_body=CONCAT(v_email_body1,v_email_body2,v_email_body3,v_email_signature);

ELSEIF(v_present_status='SENT TO APPROVER') THEN
select distinct u.user_id,u.user_name,u.first_name INTO v_email_recepient_id,v_email_to,v_email_addressee from qaip_user u where u.user_id = (select distinct o.created_by from qaip_order_mgmt o
	where o.order_id = in_entity_id);

	CALL INSERT_NOTIFICATION_EMAIL_DG_USERS_LOG(in_message_id,in_entity_id,@v_result);

	SET v_email_bcc=@v_result;

	CALL INSERT_NOTIFICATION_EMAIL_RECEPIENT_LOG(in_message_id,v_email_recepient_id,v_email_to);


SET v_email_body1=CONCAT('<html>','<body style="font-weight: normal;font-family: sans-serif;font-size: small;">','<p>Dear <a>',v_email_addressee,',</a><br><br>');
SET v_email_body2=CONCAT('The ',v_event_name,' of ',v_fund_name,' for ',v_amount,' has been cancelled. Order details can be found <a href=',v_Qualis_portal,'>here</a>.');

SET v_email_body3=CONCAT('<br><br>','</p></p><ul><li>Order No: ',in_entity_id,'</li><li>Status: ',in_entity_status,'</li><li>Status Changed at: ',v_last_updated_at,'</li><li>Dealer Group: ',v_organisation_name,'</li><li>Fund Manager: ',v_fund_manager,'</li></ul><br>');

SET v_email_body=CONCAT(v_email_body1,v_email_body2,v_email_body3,v_email_signature);
END IF;

elseif(in_entity_status='MORE INFORMATION') THEN

select distinct u.user_id,u.user_name,u.first_name,u.organisation_id INTO v_email_recepient_id,v_email_to,v_email_addressee,v_organisation_id from qaip_user u where u.user_id = (select distinct o.created_by from qaip_order_mgmt o
	where o.order_id = in_entity_id);

    select distinct u.first_name, u.last_name INTO v_action_perform_by_fname, v_action_perform_by_lname from qaip_user u where u.user_id = in_action_performed_by;

	CALL INSERT_NOTIFICATION_EMAIL_QUALIS_USERS_LOG(in_message_id,v_organisation_id,@v_result);

	SET v_email_bcc=@v_result;

	CALL INSERT_NOTIFICATION_EMAIL_RECEPIENT_LOG(in_message_id,v_email_recepient_id,v_email_to);




select distinct c.comment INTO v_user_comments from qaip_user_comments c where c.user_id=in_action_performed_by
and c.order_id=in_entity_id
and c.last_updated_date=(select max(c1.last_updated_date)
from qaip_user_comments c1
where c1.user_id=in_action_performed_by
and c1.order_id=in_entity_id);


SET v_email_body1=CONCAT('<html>','<body style="font-weight: normal;font-family: sans-serif;font-size: small;">','<p>Dear <a>',v_email_addressee,',</a><br><br>');
If(in_action='Document') THEN
SET v_email_body2=CONCAT('The order of ',v_fund_name,' for ',v_amount,' has been updated with one or more documents. Order details can be found <a href=',v_Qualis_portal,'>here</a></p><ul><li>Order No: ',in_entity_id,'</li><li>Status: ',in_entity_status,'</li><li>Status Changed at: ',v_last_updated_at,'</li><li>Dealer Group: ',v_organisation_name,'</li><li>Fund Manager: ',v_fund_manager,'</li></ul><br>');
ELSEIF(in_action='Update') THEN
SET v_email_body2=CONCAT(v_action_perform_by_fname,' ', v_action_perform_by_lname, ' requires the following information to complete the ',v_event_name,' of ',v_fund_name,' for ',v_amount,'');
SET v_email_body3=CONCAT('<br><br>',v_user_comments,'</p></p><ul><li>Order No: ',in_entity_id,'</li><li>Status: ',in_entity_status,'</li><li>Status Changed at: ',v_last_updated_at,'</li><li>Dealer Group: ',v_organisation_name,'</li><li>Fund Manager: ',v_fund_manager,'</li></ul><br>');
END IF;
SET v_email_body=CONCAT(v_email_body1,v_email_body2,v_email_body3,v_email_signature);


elseif(in_entity_status='FUNDS TRANSFERRED') THEN

select distinct u.user_id,u.user_name,u.organisation_id INTO v_email_recepient_id,v_email_bcc,v_organisation_id from qaip_user u where u.user_id = (select distinct o.created_by from qaip_order_mgmt o
	where o.order_id = in_entity_id);


CALL INSERT_NOTIFICATION_EMAIL_QUALIS_USERS_LOG(in_message_id,v_organisation_id,@v_result1);

SET v_email_bcc=@v_result1;


CALL INSERT_NOTIFICATION_ORDER_EMAIL_FM_LOG(in_entity_id,in_message_id,@v_result_addressee,@v_result);

SET v_email_to=@v_result;

SET v_email_addressee=@v_result_addressee;

SET v_email_body1=CONCAT('<html>','<body style="font-weight: normal;font-family: sans-serif;font-size: small;">','<p>Dear <a>',v_email_addressee,',</a><br><br>');
If(in_action='Document') THEN
SET v_email_body2=CONCAT('The order of ',v_fund_name,' for ',v_amount,' has been updated with one or more documents. Order details can be found <a href=',v_Qualis_portal,'>here</a></p><ul><li>Order No: ',in_entity_id,'</li><li>Status: ',in_entity_status,'</li><li>Status Changed at: ',v_last_updated_at,'</li><li>Dealer Group: ',v_organisation_name,'</li><li>Fund Manager: ',v_fund_manager,'</li></ul><br>');
ELSEIF(in_action='Update') THEN
SET v_email_body2=CONCAT('The funds for the subscription of ','',v_fund_name,' for ',v_amount,' have been wired.','</p></p><ul><li>Order No: ',in_entity_id,'</li><li>Status: ',in_entity_status,'</li><li>Status Changed at: ',v_last_updated_at,'</li><li>Dealer Group: ',v_organisation_name,'</li><li>Fund Manager: ',v_fund_manager,'</li></ul><br>');
END IF;
SET v_email_body=CONCAT(v_email_body1,v_email_body2,v_email_body3,v_email_signature);




elseif(in_entity_status='COMPLETED') THEN

select distinct u.user_id,u.user_name,u.first_name,u.organisation_id INTO v_email_recepient_id,v_email_to,v_email_addressee,v_organisation_id from qaip_user u where u.user_id = (select distinct o.created_by from qaip_order_mgmt o
	where o.order_id = in_entity_id);

	CALL INSERT_NOTIFICATION_EMAIL_QUALIS_USERS_LOG(in_message_id,v_organisation_id,@v_result);

	SET v_email_bcc=@v_result;

	CALL INSERT_NOTIFICATION_EMAIL_RECEPIENT_LOG(in_message_id,v_email_recepient_id,v_email_to);


SET v_email_body1=CONCAT('<html>','<body style="font-weight: normal;font-family: sans-serif;font-size: small;">','<p>Dear <a>',v_email_addressee,',</a><br><br>');
If(in_action='Document') THEN
SET v_email_body2=CONCAT('The order of ',v_fund_name,' for ',v_amount,' has been updated with one or more documents. Order details can be found <a href=',v_Qualis_portal,'>here</a></p><ul><li>Order No: ',in_entity_id,'</li><li>Status: ',in_entity_status,'</li><li>Status Changed at: ',v_last_updated_at,'</li><li>Dealer Group: ',v_organisation_name,'</li><li>Fund Manager: ',v_fund_manager,'</li></ul><br>');
ELSEIF(in_action='Update') THEN
SET v_email_body2=CONCAT('The funds for the subscription of ','',v_fund_name,' for ',v_amount,' </span>have been received.','</p></p><ul><li>Order No: ',in_entity_id,'</li><li>Status: ',in_entity_status,'</li><li>Status Changed at: ',v_last_updated_at,'</li><li>Dealer Group: ',v_organisation_name,'</li><li>Fund Manager: ',v_fund_manager,'</li></ul><br>');
END IF;
SET v_email_body=CONCAT(v_email_body1,v_email_body2,v_email_body3,v_email_signature);




END IF;

insert into qaip_notification_email_delivery_receipt
(email_identifier,entity_type,entity_id,email_trigger,email_triggered_status,email_triggered_by,email_triggered_date,email_sender,
email_addressee,email_subject,email_body,email_to,email_bcc,email_delivery_status)
values(in_message_id,in_entity_type,in_entity_id,in_action,in_entity_status,in_action_performed_by,
in_time_of_action,v_email_sender,v_email_addressee,v_email_subject,v_email_body,v_email_to,
v_email_bcc,'PENDING');

commit;



 insert into qaip_notification_email_profile_order
 (email_identifier,order_id,order_status,order_event,order_event_amount,fund_name,investor_name,comments,created_date,amount_requested)
 values(in_message_id,in_entity_id,in_entity_status,v_event_name,v_amount,v_fund_name,v_investor_name,null,v_order_created_date,v_amount_requested);

 commit;
 
 select * from qaip_notification_email_delivery_receipt where email_identifier=in_message_id
 and email_notify_id = (select max(email_notify_id) from qaip_notification_email_delivery_receipt where email_identifier=in_message_id);


END IF;

END